<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<title>Replacer Tests</title>

	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.0.1.css">
	<link href="../css/bootstrap.min.css" rel="stylesheet">
	<link href="../css/replacer.css" rel="stylesheet">
</head>
<body>

	<nav id="cabecera" class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">Replacer</a>
			</div>
			<ul class="nav navbar-nav">
				<li>
					<a id="link-title" href="#" target="_blank">Esto es un título muy largo que puede llegar a ocupar dos líneas en un móvil.</a>
				</li>
			</ul>
			<ul id="ul-save" class="nav navbar-nav navbar-right">
				<li>
					<a id="button-save" href="#" class="btn btn-default" role="button">Guardar cambios</a>
				</li>
			</ul>
		</div>
	</nav>

	<h1>Tests unitarios</h1>

	<div id="qunit"></div>
	<div id="qunit-fixture"></div>

	<h1>Resaltado de errores y de sintaxis</h1>

	<h2>Texto original</h2>
	<div id="contentOrig" class="pre"></div>

	<h2>Texto resaltado con errores </h2>
	<div id="contentHighlighted" class="pre"></div>

	<h2>Texto corregido</h2>
	<div id="contentFixed" class="pre"></div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/string-utils.js"></script>
	<script src="../js/regex.js"></script>
	<script src="../js/replace-utils.js"></script>
	<script src="../js/db-utils.js"></script>
	<script src="../js/wikipedia-utils.js"></script>

	<script src="https://code.jquery.com/qunit/qunit-2.0.1.js"></script>
	<script src="qunit-tests.js"></script>

	<script type="text/javascript">
		// Move down the body acording to the header height
		var headerHeight = $('#cabecera').height();
		$('body').css('padding-top', headerHeight);

		var orig = 'Z\n\n'
			+ 'X\nX\nX\nX\n'
			+ '<!-- Comentario -->\n' + '== Una google cabecera de google ==\n\n'
			+ 'Esto es un <i>ejemplo</i> de [[código]] wiki.\n'
			+ 'Un enlace: https://www.google.es a google.'
			+ '\nX\nX\nX\nX'
			+ '\n\nZ';
		var encoded = StringUtils.encodeHtml(orig);
		$('#contentOrig').html(encoded);
		$('#contentFixed').text(orig);

		var misspellings = [{word : 'google', cs : 1, suggestion : 'Google'}];
		var misspellingMatches = ReplaceUtils.findMisspellingMatches(encoded, misspellings);
		var misspelled = ReplaceUtils.replaceMisspellingsWithButtons(encoded, misspellingMatches);
		misspelled = ReplaceUtils.removeParagraphsWithoutMisspellings(misspelled);

		var highlighted = ReplaceUtils.highlightSyntax(misspelled);
		$('#contentHighlighted').html(highlighted);

		// Add event to the misspelling buttons
		$('.miss').click(function() {
			var missId = this.id;
			var idx = missId.split('-')[1];
			var missMatch = misspellingMatches[idx];
			if (missMatch.fixed) {
				$('#' + missId).removeClass('btn-success');
				$('#' + missId).addClass('btn-danger');
				$('#' + missId).html(missMatch.word);
				missMatch.fixed = false;
			} else {
				$('#' + missId).removeClass('btn-danger');
				$('#' + missId).addClass('btn-success');
				$('#' + missId).html(missMatch.fix);
				missMatch.fixed = true;
			}

			// Apply the fixes and show it
			var fixed = ReplaceUtils.replaceFixes(encoded, misspellingMatches);
			var decodedFixed = StringUtils.decodeHtml(fixed);
			$('#contentFixed').text(decodedFixed);
		});

		// Add cool Bootstrap tooltips
		$(function() {
			$('[data-toggle="tooltip"]').tooltip()
		});

		// Retrieve the title of a page with misspellings
		DataBaseUtils.getMisspelledPage(function(title) {
			alert('Page with misspellings: ' + title);
			DataBaseUtils.getPageMisspellings(title, function(misspellings) {
				alert('Misspellings in the page: ' + JSON.stringify(misspellings));
				WikipediaUtils.getPageContent(title, function(content) {
					alert('Page content:\n\n' + content);
				});
			});
		});
	</script>
</body>
</html>